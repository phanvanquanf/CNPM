@using X.PagedList.Mvc.Core
@using X.PagedList
@model IPagedList<hotels.Models.tblDatPhong>

@{
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="content-wrapper">
    <div class="container-xxl flex-grow-1 container-p-y">

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item"><a href="#">Quản lý phòng</a></li>
                <li class="breadcrumb-item active">Nhận trả phòng</li>
            </ol>
        </nav>

        <div class="card tw-p-8">
            <div class="tw-flex tw-flex-col tw-pb-5 tw-gap-1">
                <h1 class="tw-text-xl tw-capitalize tw-font-semibold">Danh sách nhận trả phòng</h1>

                <div class="tw-flex tw-items-center tw-justify-between tw-text-neutral-400 tw-text-sm">
                    <p>Hiển thị @Model.Count trên tổng @Model.TotalItemCount phòng</p>

                    <div class="tw-flex tw-items-center tw-gap-3">
                        <!-- Bộ lọc trạng thái -->
                        <div class="btn-group">
                            <button type="button" class="tw-flex tw-items-center tw-gap-1 tw-px-2 tw-h-8 tw-cursor-pointer tw-rounded-lg 
                                tw-border tw-border-solid tw-border-neutral-200/80 tw-text-xs dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Trạng thái
                            </button>

                            <ul class="dropdown-menu !tw-text-xs" id="statusFilter">
                                <li><a class="dropdown-item" href="javascript:void(0);" data-value="">Tất cả</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" data-value="1">Đã nhận</a>
                                </li>
                                <li><a class="dropdown-item" href="javascript:void(0);" data-value="2">Chờ nhận
                                        phòng</a>
                                </li>
                            </ul>
                        </div>

                        <!-- Ô tìm kiếm -->
                        <div
                            class="tw-flex tw-items-center tw-gap-2 tw-w-64 tw-h-8 tw-border tw-border-solid tw-border-neutral-200/80 tw-rounded-lg tw-px-2.5">
                            <i data-lucide="search" class="tw-text-neutral-400 tw-w-4 tw-h-4"></i>
                            <input type="text" placeholder="Tìm kiếm phòng..." id="searchInput"
                                class="tw-w-full tw-outline-none tw-text-xs tw-text-neutral-400" />
                        </div>

                    </div>
                </div>
            </div>

            <!-- Include Partial Table -->
            <div id="employeeList" class="tw-mt-4">
                <partial name="_CheckInOutPartial" model="Model" />
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let debounceTimer;
        let currentSearch = '';
        let currentStatus = '';

        const searchInput = document.getElementById("searchInput");
        const statusFilter = document.getElementById("statusFilter");

        // Debounced search function
        function debounceSearch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                currentSearch = searchInput.value.trim();
                loadPage(1, currentSearch, currentStatus);
            }, 500);
        }

        // Search input event listener
        if (searchInput) {
            searchInput.addEventListener("input", debounceSearch);
        }

        // Status filter event listener
        if (statusFilter) {
            statusFilter.querySelectorAll("a").forEach(item => {
                item.addEventListener("click", function (e) {
                    e.preventDefault();
                    currentStatus = this.getAttribute("data-value");
                    loadPage(1, currentSearch, currentStatus);
                });
            });
        }

        // Load page function with search and status
        function loadPage(page, search = '', status = '') {
            if (page < 1) return;
            const url = `@Url.Action("CheckInOut", "Room", new { area = "Admin" })?page=${page}&search=${encodeURIComponent(search)}&status=${status}`;
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
                .then(res => res.text())
                .then(html => {
                    document.getElementById("employeeList").innerHTML = html;
                    if (lucide) lucide.createIcons();
                    attachPaginationHandlers();
                })
                .catch(err => console.error("Lỗi load trang:", err));
        }

        // Attach pagination handlers
        function attachPaginationHandlers() {
            const container = document.getElementById("checkinout-container");
            if (!container) return;

            const prevBtn = container.querySelector("#prevPage");
            const nextBtn = container.querySelector("#nextPage");
            const pageButtons = container.querySelectorAll("#pagination button");

            if (prevBtn) {
                prevBtn.addEventListener("click", () => {
                    const page = parseInt(prevBtn.dataset.page);
                    if (page >= 1) loadPage(page, currentSearch, currentStatus);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener("click", () => {
                    const page = parseInt(nextBtn.dataset.page);
                    loadPage(page, currentSearch, currentStatus);
                });
            }

            pageButtons.forEach(btn => {
                btn.addEventListener("click", () => {
                    loadPage(parseInt(btn.dataset.page), currentSearch, currentStatus);
                });
            });
        }

        // Initial attachment of pagination handlers
        attachPaginationHandlers();
    });
</script>